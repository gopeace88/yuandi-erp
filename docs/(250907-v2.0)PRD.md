# (250907-v2.0)PRD.md — YUANDI Collection Management System

## 버전 히스토리

| 버전 | 날짜 | 작성자 | 변경사항 |
|------|------|--------|----------|
| v1.0 | 2024-08-24 | 초기 작성 | PRD 최초 작성 |
| v1.1 | 2024-08-25 | 개발팀 | 반복 개발 프로세스 추가 |
| v2.0 | 2025-09-07 | 개발팀 | PRD_v2 통합, 이중 배송 시스템 추가 |
| v2.1 | 2025-09-07 | 개발팀 | CASCADE DELETE 제약조건 추가 |

---

## 📚 프로젝트 문서 체계

### 문서 구조 및 역할

| 문서명 | 경로 | 역할 | 주요 내용 |
|--------|------|------|-----------|
| **CLAUDE.md** | `/CLAUDE.md` | AI 개발 가이드 | 프로젝트 마스터 가이드, 개발 지침 |
| **README.md** | `/README.md` | 프로젝트 소개 | 빠른 시작, 기술 스택, 설치 방법 |
| **PRD.md** | `/docs/(250907-v2.0)PRD.md` | 제품 요구사항 | 기능 명세, 업무 프로세스, API 정의 |
| **DATABASE_ERD.md** | `/docs/(250907-v1.1)DATABASE_ERD.md` | DB 스키마 | [섹션 8](#8-데이터베이스-스키마) 참조 |
| **SETUP_GUIDE.md** | `/docs/(250907-v1.0)SETUP_GUIDE.md` | 초기 설정 | [섹션 10.1](#101-초기-환경-구축) 참조 |
| **DEPLOYMENT_GUIDE.md** | `/docs/(250907-v1.0)DEPLOYMENT_GUIDE.md` | 배포 가이드 | [섹션 10.2](#102-배포-프로세스) 참조 |
| **MAINTENANCE_GUIDE.md** | `/docs/(250907-v1.0)MAINTENANCE_GUIDE.md` | 유지보수 | [섹션 10.3](#103-유지보수-및-운영) 참조 |
| **ITERATIVE_DEVELOPMENT.md** | `/docs/(250907-v1.0)ITERATIVE_DEVELOPMENT.md` | 개발 프로세스 | [섹션 10.4](#104-반복적-개발-프로세스) 참조 |

### 참조 우선순위
1. **CLAUDE.md** - 개발 시 최우선 참조
2. **PRD.md** (이 문서) - 기능 요구사항 확인
3. **DATABASE_ERD.md** - 데이터베이스 구조 확인
4. 기타 문서 - 필요 시 참조

---

## 0. 목적 및 배경

**사업 형태**: 1인이 운영하는 해외물건 구매대행 사업자용 시스템

**핵심 기능**: 
- 주문 관리 시스템 (Order Management)
- 이중 배송 시스템 (한국+중국 분리 관리)
- 재고 관리 with 이미지 (Inventory with Images)
- 출납장부 모니터링 (Cashbook Monitoring)
- 고객 비로그인 주문 조회 (Customer Order Lookup)

**설계 원칙**: 
- 복잡한 WMS/회계 제외
- 재고는 단일 수량(onHand)으로만 관리
- PC/모바일 직관적 UI
- 반복 개선 개발 (Iterative Development)

**기술 스택**:
- Frontend: Next.js 14 (App Router), TypeScript, Tailwind CSS
- Backend: Supabase (PostgreSQL, Auth, Realtime, Storage)
- Deployment: Vercel (Edge Functions, Cron Jobs)
- Architecture: Serverless with Supabase + Vercel

## 1. 사용자 및 권한

| 역할 (DB) | 한국어 표시 | 중국어 표시 | 접근 권한 | 주요 업무 |
|-----------|------------|------------|-----------|-----------|
| **admin** | 시스템 관리자 | 系统管理员 | 전체 기능 | 사용자 관리, 모든 주문/재고/배송 처리, 출납장부, 엑셀 다운로드 |
| **order_manager** | 주문 관리자 | 订单管理员 | 주문 관리만 | 주문 생성/수정, 재고 관리, 출납장부 조회 |
| **ship_manager** | 배송 관리자 | 配送管理员 | 배송 관리만 | 송장 등록, 출고 처리, 출납장부 조회 |
| **customer** | 고객 | 客户 | 조회만 | 이름 + 전화번호로 본인 주문 조회 |

**공통 권한**: 모든 로그인 사용자는 출납장부 조회 가능
**언어 설정**: 화면 상단에서 KR/CN 토글을 통해 UI 언어 전환 (사용자별 기본 언어 저장)

## 2. 비즈니스 플로우

### 주요 상태 정의
- **PAID**: 입금 확인 후 주문 생성 완료
- **SHIPPED**: 물류업체 수거 완료, 송장번호 등록
- **DONE**: 정상 완료 (수동 처리)
- **REFUNDED**: 환불 처리 (재고 복구 없음)

### 2.1 재고 입고 플로우 (상품 등록 통합)
```
재고 입고 화면:
1. 상품명 입력 → 동일 이름 있으면 드롭다운 표시
2. 모델명 입력 → 동일 모델명 있으면 드롭다운 표시
3-A. 기존 상품 선택 시:
    → 기존 상품 정보 자동 로드
    → 수량과 입고단가(CNY)만 입력
    
3-B. 신규 상품인 경우:
    → 카테고리, 색상, 브랜드 추가 입력
    → products 테이블에 신규 생성
    → SKU 자동생성: [카테고리]-[모델]-[색상]-[브랜드]-[HASH5]

4. 공통 처리:
    → products.onHand 증가
    → inventory_movements 기록 (입고 이력)
    → cashbook 기록 (type: 'inbound', 매입 지출)
    → event_logs 기록
```

### 2.2 주문 생성 플로우 (PAID)
```
주문 생성 (단일 상품):
→ 상품 1개 선택
→ 재고 확인 (products.onHand >= 1)
→ orders 생성 (status: 'PAID', 단일 상품)
→ products.onHand 감소 (-1)
→ inventory_movements 기록 (판매 이력)
→ cashbook 기록 (type: 'sale', 판매 수입)
→ event_logs 기록
```

### 2.3 배송 처리 플로우 (PAID → SHIPPED)
```
송장 등록:
→ orders.status = 'SHIPPED'
→ shipments 생성 (송장번호, 택배사)
→ event_logs 기록
```

### 2.4 주문 완료 플로우 (SHIPPED → DONE)
```
완료 처리:
→ orders.status = 'DONE'
→ shipments.delivered_at 업데이트
→ event_logs 기록
```

### 2.5 환불 플로우 (SHIPPED/DONE → REFUNDED)
```
배송 후 환불:
→ orders.status = 'REFUNDED'
→ cashbook_transactions 기록 (type: 'REFUND', 환불)
→ ❌ 재고 복구 없음 (물건 회수 없음)
→ event_logs 기록
```

### 2.6 재고 조정 플로우
```
재고 조정 (분실/불량):
→ products.onHand 감소
→ inventory_movements 기록 (조정 이력)
→ cashbook 기록 (type: 'adjustment', 손실)
→ event_logs 기록
```

### 2.7 배송 플로우 (이중 배송 시스템)
```
한국 배송:
→ orders.korea_tracking 등록
→ shipments 생성 (type: 'KOREA')
→ 배송 상태 추적

중국 배송:
→ orders.china_tracking 등록  
→ shipments 생성 (type: 'CHINA')
→ 별도 상태 추적
```

## 3. 기능 요구사항

### 3.1 재고 관리 (상품 관리 통합)

**재고 입고 (상품 등록 포함)**:
- 상품명/모델명 입력 시 기존 상품 자동완성
- 신규 상품: 카테고리, 색상, 브랜드 추가 입력
- 기존 상품: 수량과 입고단가만 입력
- SKU 자동생성: `[카테고리]-[모델]-[색상]-[브랜드]-[HASH5]`

**재고 관리**:
- `onHand`: 현재 보유 수량 (단순 수량 관리)
- 재고차감: 주문 생성 시 자동 차감
- 재고복구: 취소 시에만 복구 (환불 시 복구 없음)
- 재고조정: 분실/불량 시 차감 처리

### 3.2 주문 처리

**주문 생성**:
- 필수 정보: 고객명, 전화번호, 해외통관부호(PCCC), 배송주소
- 상품: 복수 상품 선택 가능 (order_items 테이블)
- 주소 입력: Daum 우편번호 API 연동
- **실시간 재고 표시**: 재고 있는 상품만 선택 가능
- 주문번호 자동생성: `ORD-YYMMDD-###`
- 주문 생성 시 자동으로 PAID 상태
- cashbook_transactions와 inventory_logs 자동 기록

**주문 상태 변경**:
- PAID → SHIPPED: 송장번호 입력 (한국/중국 구분)
- SHIPPED → DONE: 배송 완료
- SHIPPED/DONE → REFUNDED: 환불 (재고 복구 없음)

### 3.3 출고 및 배송 관리 (이중 배송 시스템)

**한국 배송**:
- 한국 택배사, 송장번호 입력
- 송장 사진 업로드 (선택사항)
- tracking_url 자동 생성 (택배사별 URL 패턴)
- shipments 테이블에 type='KOREA'로 저장

**중국 배송**:
- 중국 택배사, 송장번호 입력
- 별도 추적 URL 생성
- shipments 테이블에 type='CHINA'로 저장
- 별도 상태 관리

### 3.4 고객 주문 조회 (/track)

**조회 방법**: 이름 + 전화번호 전체 입력
**결과 표시**: 최근 5건을 카드 형태로 표시 (주문상태, 송장번호, 추적링크)
**언어 지원**: 브라우저 언어 자동 감지 + 수동 토글 가능

### 3.5 관리 기능

**출납장부 (Cashbook)**:
- 거래 유형: sale(판매), inbound(입고), adjustment(조정), refund(환불)
- 일/주/월별 합계 및 순익 계산
- 통화: CNY/KRW, 환율 적용

**환율 시스템**:
- 한국수출입은행 API를 통한 실시간 환율 조회
- API 문서: https://www.koreaexim.go.kr/ir/HPHKIR020M01?apino=2&viewtype=C#none
- 매일 자정 자동 업데이트 (Vercel Cron)
- 원가(CNY)와 판매가(KRW) 자동 환산
- 상세 구현: [EXCHANGE_RATE_SYSTEM_PROPOSAL.md](./EXCHANGE_RATE_SYSTEM_PROPOSAL.md)

**엑셀 내보내기**:
- 주문 목록, 재고 현황, 출납장부를 .xlsx 형식으로 다운로드
- UTF-8 인코딩, 통화/날짜 포맷 유지
- 현재 필터 조건 반영하여 내보내기

### 3.6 대시보드

**매출 현황** (전체 사용자):
- 오늘/이번주/이번달 매출액 (KRW 기준)
- 전일/전주/전월 대비 증감률
- 주문 건수 및 평균 주문 금액

**재고 현황** (admin, order_manager):
- 전체 상품 수량
- 재고 부족 상품 (설정 임계값 이하)
- 재고 가치 (CNY/KRW 기준)

**주문 현황** (전체 사용자):
- 상태별 주문 건수 (PAID/SHIPPED/DONE/CANCELLED/REFUNDED)
- 처리 대기 주문 (각 역할별 할 일)
- 최근 주문 5건 (간단 정보)

**주문 검색**: 고객명, 전화번호, 주문번호, 송장번호
**주문 필터**: 상태별(PAID/SHIPPED/DONE/CANCELLED/REFUNDED), 기간별
**재고 검색**: 상품명, 모델명, 색상, 브랜드
**기간별 조회**: 주문일자, 출고일자, 입고일자 기준

## 4. UI/UX 설계

### 4.1 상단 네비게이션 (역할별 차등 노출)

**admin**: 대시보드 | 주문 관리 | 재고 관리 | 배송 관리 | 고객 조회(/track) | 출납장부 | 작업 로그 | 사용자 관리
**order_manager**: 대시보드 | 주문 관리 | 재고 관리 | 출납장부 | 작업 로그
**ship_manager**: 대시보드 | 배송 관리 | 출납장부 | 작업 로그

**공통**: 언어 토글 (한국어/中文) + 사용자 프로필

### 4.2 대시보드 화면 (전체 사용자)

**상단 요약 카드**:
- 오늘 매출 / 이번주 매출 / 이번달 매출 (전 기간 대비 증감률 표시)
- 처리 대기 주문 (역할별: order_manager-신규주문, ship_manager-배송대기)

**중단 차트**:
- 최근 7일 매출 트렌드 (선형 차트)
- 상태별 주문 분포 (도넛 차트)

**하단 위젯**:
- 재고 부족 상품 (admin/order_manager만 표시)
- 최근 주문 5건 (간단 정보)
- 인기 상품 TOP 5 (주문량 기준)
**상단**: 주문 생성 폼 (고객정보 + 품목 선택)
**하단**: 주문 목록 (검색/필터/정렬)
- 각 행: 주문번호, 고객명, 상태, 주문금액, 최근 업데이트
- order_manager 빠른 액션: [주문수정] (PAID 상태만)
- admin 빠른 액션: [주문수정] [송장등록] [출고완료] [환불처리]

### 4.3 주문 관리 화면 (admin, order_manager)
**상단**: 주문 생성 폼 (고객정보 + 단일 상품 선택)
- **실시간 재고 표시**: 상품 선택 드롭다운에 재고수량 표시
- **재고 부족 경고**: 재고 0개 시 선택 불가
- **판매가 표시**: 상품 선택 시 판매가격 표시

**하단**: 주문 목록 (검색/필터/정렬)
- 각 행: 주문번호, 고객명, 상태, 주문금액, 최근 업데이트
- order_manager 빠른 액션: [주문수정] (PAID 상태만)
- admin 빠른 액션: [주문수정] [송장등록] [출고완료] [환불처리]

### 4.4 재고 관리 화면 (admin, order_manager)
**재고 등록**:
- 상품명/모델명 입력 시 자동완성
- 기존 상품: 수량과 입고단가만 입력
- 신규 상품: 카테고리, 색상, 브랜드 추가 입력
**재고 조정**: 분실/불량 등록

### 4.5 배송 관리 화면 (admin, ship_manager)
**대기 주문**: PAID 상태 주문 목록 (송장 등록 대기)
**배송 중 주문**: SHIPPED 상태 주문 목록 (완료 처리 대기)
- 빠른 액션: [송장등록] [출고완료] [환불처리]
- 송장 사진 업로드 기능

### 4.6 출납장부 화면 (전체 사용자)
**요약 카드**: 일/주/월별 매출, 비용, 순익
**거래 내역**: 필터링 가능한 거래 목록
**엑셀 다운로드**: admin만 다운로드 버튼 노출

### 4.7 설정 화면 (admin 전용)

**탭 구성**:
- 사용자 관리: 사용자 추가/수정/삭제
- 카테고리 관리: 상품 카테고리 추가/수정
- 출납유형 관리: 수입/지출/조정 유형 관리
- 기타: 시스템 전역 설정 관리

**시스템 설정 (기타 탭)**:
- 재고 부족 임계값: 기본값 5개 (신규 상품 등록 시 자동 적용)
  - 설정 범위: 1~100개
  - 한국어: "기본 재고 부족 임계값"
  - 중국어: "默认库存不足阈值"

### 4.8 작업 로그 화면 (전체 사용자)

**상단 필터**:
- 작업자 선택 (드롭다운)
- 작업 유형 (주문관리, 재고관리, 배송관리, 시스템관리)
- 기간 선택 (오늘, 어제, 최근 7일, 최근 30일, 직접 입력)
- 대상별 검색 (주문번호, 상품명, 고객명)

**로그 목록** (테이블 형태):
- 시간 | 작업자 | 작업 유형 | 대상 | 변경 내용 | IP
- 페이지네이션 (최신순 정렬)
- 각 행 클릭 시 상세 모달 (Before/After 비교)

**빠른 필터 탭**:
- 전체 | 내 작업만 | 주문 관련 | 재고 관련 | 배송 관련

### 4.9 반응형 설계
- 모바일: 1열 레이아웃, 터치 친화적 버튼 (≥44px)
- PC: 2-3열 레이아웃, 키보드 단축키 지원

## 5. 데이터 모델 (Supabase/Postgres)

> **참고**: 전체 데이터베이스 스키마는 [DATABASE_ERD.md](./DATABASE_ERD.md) 참조

```sql
-- 카테고리 관리
categories {
  id: uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  code: varchar(50) UNIQUE NOT NULL,
  name: varchar(100) NOT NULL,
  name_ko: varchar(100) NOT NULL,
  name_zh: varchar(100) NOT NULL,
  description: text,
  display_order: integer DEFAULT 999,
  active: boolean DEFAULT true,
  created_at: timestamp DEFAULT now(),
  updated_at: timestamp DEFAULT now(),
  created_by: uuid
}

-- 사용자 프로필 (Supabase Auth와 연동)
user_profiles {
  id: uuid PRIMARY KEY, -- auth.users.id와 동일
  email: varchar NOT NULL,
  name: varchar NOT NULL,
  role: enum('ADMIN', 'ORDER_MANAGER', 'SHIP_MANAGER'),
  locale: enum('ko', 'zh-CN', 'en') DEFAULT 'ko',
  active: boolean DEFAULT true,
  created_at: timestamp DEFAULT now(),
  updated_at: timestamp DEFAULT now()
}

-- 상품 (이미지 지원 추가, 다국어 필드 추가)
products {
  id: uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  sku: varchar(100) UNIQUE NOT NULL,
  category: varchar(50) NOT NULL,
  category_id: uuid REFERENCES categories(id),
  name: varchar NOT NULL,
  name_ko: varchar(255), -- 한글 상품명
  name_zh: varchar(255), -- 중문 상품명
  model: varchar,
  color: varchar,
  color_ko: varchar(100), -- 한글 색상
  color_zh: varchar(100), -- 중문 색상
  brand: varchar(100), -- 브랜드
  brand_ko: varchar(100), -- 한글 브랜드
  brand_zh: varchar(100), -- 중문 브랜드
  manufacturer: varchar, -- 브랜드/제조사
  cost_cny: decimal NOT NULL,
  price_krw: decimal NOT NULL,
  on_hand: integer DEFAULT 0,
  low_stock_threshold: integer DEFAULT 5,
  image_url: varchar, -- 상품 이미지
  active: boolean DEFAULT true,
  created_by: uuid REFERENCES user_profiles(id),
  created_at: timestamp DEFAULT now(),
  updated_at: timestamp DEFAULT now()
}

-- 주문
orders {
  id: uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  order_no: varchar UNIQUE NOT NULL,
  customer_name: varchar NOT NULL,
  customer_phone: varchar NOT NULL,
  pccc_code: varchar, -- 해외통관부호
  shipping_address: text NOT NULL,
  zip_code: varchar,
  memo: text,
  total_amount: decimal NOT NULL,
  currency: varchar DEFAULT 'KRW',
  status: enum('PAID', 'SHIPPED', 'DELIVERED', 'DONE', 'REFUNDED', 'CANCELLED'),
  korea_tracking: varchar, -- 한국 송장번호
  china_tracking: varchar, -- 중국 송장번호
  created_by: uuid REFERENCES user_profiles(id),
  created_at: timestamp DEFAULT now(),
  updated_at: timestamp DEFAULT now()
}

-- 주문 상품 (복수 상품 지원)
order_items {
  id: uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  order_id: uuid REFERENCES orders(id) ON DELETE CASCADE,
  product_id: uuid REFERENCES products(id),
  product_name: varchar NOT NULL,
  product_sku: varchar NOT NULL,
  quantity: integer NOT NULL DEFAULT 1,
  unit_price: decimal NOT NULL,
  subtotal: decimal NOT NULL,
  created_at: timestamp DEFAULT now()
}

-- 배송 (이중 배송 시스템 - 한국/중국)
shipments {
  id: uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  order_id: uuid UNIQUE REFERENCES orders(id) ON DELETE CASCADE,
  courier: varchar(50),                -- 한국 택배사
  courier_code: varchar(20),
  tracking_no: varchar(50),            -- 한국 송장번호
  tracking_barcode: varchar(100),
  tracking_url: varchar(500),          -- 한국 추적 URL
  courier_cn: varchar(50),             -- 중국 택배사
  tracking_no_cn: varchar(100),        -- 중국 송장번호
  tracking_url_cn: varchar(500),       -- 중국 추적 URL
  shipping_fee: decimal(10,2) DEFAULT 0,
  actual_weight: decimal(10,2),
  volume_weight: decimal(10,2),
  shipment_photo_url: varchar(500),
  receipt_photo_url: varchar(500),
  shipped_at: timestamp,
  delivered_at: timestamp,
  created_at: timestamp DEFAULT now(),
  created_by: uuid
}

-- 재고 관리
inventory {
  id: uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  product_id: uuid NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  on_hand: integer DEFAULT 0,
  allocated: integer DEFAULT 0,
  available: integer GENERATED ALWAYS AS (on_hand - allocated) STORED,
  last_updated: timestamp DEFAULT now(),
  created_at: timestamp DEFAULT now(),
  updated_at: timestamp DEFAULT now(),
  UNIQUE(product_id)
}

-- 환율 관리
exchange_rates {
  id: uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  base_currency: varchar(10) NOT NULL,
  target_currency: varchar(10) NOT NULL,
  rate: decimal(10,4) NOT NULL,
  source: varchar(50) DEFAULT 'manual',
  valid_from: date NOT NULL,
  valid_to: date,
  is_active: boolean DEFAULT true,
  created_at: timestamp DEFAULT now(),
  updated_at: timestamp DEFAULT now(),
  UNIQUE(base_currency, target_currency, valid_from)
}

-- 시스템 설정
system_settings {
  id: uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  key: varchar(100) UNIQUE NOT NULL,
  value: text NOT NULL,
  value_type: varchar(20) CHECK IN ('string', 'number', 'boolean', 'json'),
  category: varchar(50) DEFAULT 'general',
  name_ko: varchar(100) NOT NULL,
  name_zh: varchar(100) NOT NULL,
  description_ko: text,
  description_zh: text,
  min_value: decimal(10,2),
  max_value: decimal(10,2),
  default_value: text,
  is_required: boolean DEFAULT true,
  is_editable: boolean DEFAULT true,
  display_order: integer DEFAULT 999,
  created_at: timestamp DEFAULT now(),
  updated_at: timestamp DEFAULT now(),
  updated_by: uuid
}

-- 이벤트 로그 (감사 추적)
event_logs {
  id: uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  actor_id: uuid,
  actor_name: varchar(100),
  actor_role: user_role,
  event_type: varchar(50) NOT NULL,
  event_category: varchar(50),
  event_severity: varchar(20) DEFAULT 'info',
  entity_type: varchar(50),
  entity_id: uuid,
  entity_name: varchar(200),
  action: varchar(50),
  before_data: jsonb,
  after_data: jsonb,
  changes: jsonb,
  ip_address: inet,
  user_agent: text,
  request_id: uuid,
  created_at: timestamp DEFAULT now()
}

-- 출납장부 유형 관리
cashbook_types {
  id: uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  code: varchar(50) NOT NULL UNIQUE,
  name_ko: varchar(100) NOT NULL,
  name_zh: varchar(100) NOT NULL,
  type: varchar(20) CHECK IN ('income', 'expense', 'adjustment'),
  color: varchar(7) DEFAULT '#6B7280',
  description: text,
  display_order: integer DEFAULT 999,
  is_system: boolean DEFAULT false,
  active: boolean DEFAULT true,
  created_at: timestamp DEFAULT now(),
  updated_at: timestamp DEFAULT now()
}

-- 출납장부
cashbook_transactions {
  id: uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  transaction_date: date NOT NULL,
  type: cashbook_type NOT NULL, -- ENUM 타입
  amount: decimal, -- NULL 허용 (기본 통화 금액)
  amount_cny: decimal, -- 위안화 금액
  currency: enum('CNY', 'KRW') DEFAULT 'KRW',
  exchange_rate: decimal DEFAULT 1,
  amount_krw: decimal NOT NULL, -- 원화 환산 금액 (필수)
  balance_krw: decimal NOT NULL, -- 잔액 (필수)
  reference_type: varchar,
  reference_id: uuid,
  ref_no: varchar(50),
  description: text,
  notes: text,
  bank_name: varchar(50),
  account_no: varchar(50),
  category: varchar(50),
  tags: text[],
  created_by: uuid REFERENCES user_profiles(id),
  created_at: timestamp DEFAULT now()
}

-- cashbook_type ENUM 정의
cashbook_type: enum(
  -- 수입
  'sale', 'refund_cancel', 'other_income',
  -- 지출
  'inbound', 'refund', 'shipping', 'operation_cost', 'other_expense',
  -- 조정
  'adjustment', 'loss', 'correction'
)

-- 재고 이동 이력
inventory_movements {
  id: uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  product_id: uuid REFERENCES products(id) ON DELETE CASCADE,
  movement_type: enum('inbound', 'sale', 'adjustment', 'disposal') NOT NULL,
  quantity: integer NOT NULL,
  balance_before: integer NOT NULL,
  balance_after: integer NOT NULL,
  ref_type: varchar(50),
  ref_id: uuid,
  ref_no: varchar(50),
  unit_cost: decimal(10,2),
  total_cost: decimal(12,2),
  note: text,
  movement_date: date DEFAULT CURRENT_DATE,
  created_at: timestamp DEFAULT now(),
  created_by: uuid
}
```

## 6. API 설계

### 6.1 대시보드 (전체 사용자)
```http
GET /api/dashboard/summary           # 매출/주문/재고 요약 정보
GET /api/dashboard/sales-trend       # 매출 트렌드 (최근 7일)
GET /api/dashboard/order-status      # 상태별 주문 분포
GET /api/dashboard/low-stock         # 재고 부족 상품 (admin/order_manager)
GET /api/dashboard/popular-products  # 인기 상품 TOP 5
```

### 6.2 인증 및 권한
```http
POST /api/auth/login                # 로그인
POST /api/auth/logout               # 로그아웃
GET /api/auth/me                    # 현재 사용자 정보
```

### 6.3 주문 관리 (admin, order_manager)
```http
POST /api/orders                    # 주문 생성 (단일 상품)
GET /api/orders                     # 주문 목록 조회
GET /api/orders/:id                 # 주문 상세 조회
PATCH /api/orders/:id               # 주문 수정 (PAID만)
PATCH /api/orders/:id/cancel        # 주문 취소 (PAID → CANCELLED)
DELETE /api/orders/:id              # 주문 삭제 (admin만)
```

### 6.4 배송 관리 (admin, ship_manager)
```http
GET /api/orders?status=PAID         # 배송 대기 주문 조회
PATCH /api/orders/:id/ship          # 송장 등록 (PAID → SHIPPED)
PATCH /api/orders/:id/complete      # 주문 완료 (SHIPPED → DONE)
PATCH /api/orders/:id/refund        # 환불 처리 (SHIPPED/DONE → REFUNDED)
```

### 6.5 재고 관리 (admin, order_manager)
```http
GET /api/products                   # 상품 목록 조회
GET /api/products/search            # 상품명/모델명 검색 (자동완성)
POST /api/inventory/inbound         # 입고 등록 (상품 생성 포함)
PATCH /api/inventory/adjust         # 재고 조정 (분실/불량)
GET /api/inventory/movements        # 재고 이동 이력
```

### 6.6 고객 조회 (공개)
```http
GET /api/track?name=김철수&phone=01012345678  # 고객 주문 조회
```

### 6.8 작업 로그 (전체 사용자)
```http
GET /api/activity-logs              # 작업 로그 목록 조회
GET /api/activity-logs/:id          # 작업 로그 상세 조회
GET /api/activity-logs/my           # 내 작업 로그만 조회
GET /api/activity-logs/order/:orderId  # 특정 주문의 전체 이력
GET /api/activity-logs/product/:productId  # 특정 상품의 전체 이력
```

### 6.9 출납장부 (전체 사용자 조회, admin 다운로드)
```http
GET /api/cashbook?from=2024-01-01&to=2024-12-31  # 출납장부 조회 (전체)
GET /api/export/orders.xlsx                       # 주문 엑셀 다운로드 (admin)
GET /api/export/inventory.xlsx                    # 재고 엑셀 다운로드 (admin)  
GET /api/export/cashbook.xlsx                     # 출납장부 엑셀 다운로드 (admin)
```

**출납유형 (시스템 초기화시 필수 생성)**:

**수입 유형** (시스템 기본값):
- `sale` (판매/销售): 고객 주문에 따른 수입
- `refund_cancel` (환불취소/退款取消): 환불 취소로 인한 수입
- `other_income` (기타수입/其他收入): 기타 수입

**지출 유형** (시스템 기본값):
- `inbound` (입고/入库): 상품 구매/입고 시 발생하는 지출
- `refund` (환불/退款): 고객 환불로 인한 지출
- `shipping_fee` (배송비/运费): 배송 관련 비용
- `operation_cost` (운영비/运营费): 사무실 임대료, 인건비 등
- `other_expense` (기타지출/其他支出): 기타 지출

**조정 유형** (시스템 기본값):
- `adjustment` (조정/调整): 재고 조정 등 기타 조정 항목
- `loss` (손실/损失): 재고 손실, 파손 등
- `correction` (정정/更正): 입력 오류 정정

**출납장부 자동 입력 규칙**:
| 이벤트 | 출납유형 | 금액 | 설명 |
|--------|----------|------|------|
| 신규 상품 등록 (입고) | `inbound` | 원가 × 수량 (지출) | 상품 구매/입고 |
| 재고 추가 입고 | `inbound` | 원가 × 수량 (지출) | 재고 보충 |
| 주문 생성 (결제완료) | `sale` | 판매가 (수입) | 고객 주문 수입 |
| 송장 입력 (배송 시작) | `shipping` | 배송비 (지출) | 배송 비용 발생 |
| 환불 처리 | `refund` | 환불금액 (지출) | 고객 환불 |

### 6.7 사용자 관리 (admin만)
```http
GET /api/users                      # 사용자 목록 조회
POST /api/users                     # 사용자 초대
PATCH /api/users/:id                # 사용자 정보 수정
PATCH /api/users/:id/deactivate     # 사용자 비활성화
```

### 6.10 시스템 설정 (admin만)
```http
GET /api/system-settings            # 전체 시스템 설정 조회
GET /api/system-settings?category=inventory  # 카테고리별 설정 조회
PATCH /api/system-settings          # 설정값 업데이트 (변경된 것만)
```

### 6.8 파일 업로드
```http
POST /api/upload/shipment-photo     # 송장 사진 업로드
```

## 7. 비기능 요구사항

### 7.1 성능
- 응답 시간: 3초 이내
- 동시 사용자: 5명 이하 (1인 사업자 기준)
- 데이터베이스: 주문 10,000건, 상품 1,000개 수준

### 7.2 보안
- JWT 기반 인증
- HTTPS 통신 (Let's Encrypt)
- SQL Injection 방지
- XSS 방지

### 7.3 백업 및 복구
- 일일 자동 백업 (Supabase 기본 제공)
- 중요 데이터 주간 로컬 백업

### 7.4 국제화 (i18n)
- 지원 언어: 한국어, 중국어 간체
- 사용자별 기본 언어 설정 저장
- 날짜/통화 포맷 현지화

### 7.5 모니터링
- 에러 로깅 (Sentry 또는 유사 서비스)
- 기본적인 사용량 추적

## 8. 수용 기준

### 8.1 재고 및 상품 관리
- [ ] 재고 입고 시 상품 자동완성 기능
- [ ] SKU 자동 생성 및 중복 방지
- [ ] 재고 부족 시 주문 생성 차단
- [ ] 취소 시 재고 복구, 환불 시 재고 미복구

### 8.2 주문 처리
- [ ] 주문번호 자동 생성 (ORD-YYMMDD-###)
- [ ] 단일 상품 1개 주문 처리
- [ ] 상태 변경 시 이벤트 로그 및 자동 기록
- [ ] Daum 우편번호 API 연동
- [ ] CANCELLED 상태 추가 및 재고 복구

### 8.3 고객 조회
- [ ] 이름 + 전화번호 전체 일치 시에만 조회 가능
- [ ] 최근 5건 주문 카드 형태 표시
- [ ] 송장 추적 링크 자동 생성

### 8.4 출납장부
- [ ] 주문, 입고, 취소, 환불, 조정 자동 기록
- [ ] 일/주/월별 합계 계산
- [ ] 엑셀 다운로드 정상 동작

### 8.8 작업 추적
- [ ] 모든 중요 작업 자동 로깅
- [ ] 작업자, 시간, 변경 내용 정확히 기록
- [ ] 특정 주문/상품의 전체 이력 조회 가능
- [ ] 실시간 작업 로그 조회 및 필터링
- [ ] IP 주소 및 User-Agent 기록

### 8.9 다국어
- [ ] 역할별 메뉴 노출 제어
- [ ] API 엔드포인트 권한 검증
- [ ] order_manager는 PAID 상태 주문만 수정 가능
- [ ] 출납장부는 모든 사용자 조회 가능, 다운로드는 admin만
- [ ] 언어 토글 동작
- [ ] 사용자별 기본 언어 저장
- [ ] /track 페이지 브라우저 언어 감지

## 9. 향후 확장 계획

### Phase 2 (선택사항)
- SMS/이메일 알림 기능
- 고객 등급별 할인 관리
- 간단한 매출 대시보드
- 모바일 앱 (PWA)

### Phase 3 (선택사항)  
- 공급업체 관리
- 다중 창고 지원
- API 연동 (택배 추적, 환율)

---

**개발 예상 기간**: 4-6주
**기술 스택**: Next.js + Supabase + Tailwind CSS
**배포 환경**: Vercel + Supabase Cloud (또는 Docker/NAS)

## 10. 배포 및 환경 구축

> **자세한 내용은 다음 문서 참조**:
> - [SETUP_GUIDE.md](../SETUP_GUIDE.md) - 초기 환경 구축 가이드
> - [DEPLOYMENT_GUIDE.md](../DEPLOYMENT_GUIDE.md) - 배포 가이드
> - [MAINTENANCE_GUIDE.md](../MAINTENANCE_GUIDE.md) - 데이터 관리 가이드

### 10.1 Vercel 배포 최적화

> **"안 깨지는 최소 Next.js + Supabase 블루프린트"**
> 
> 이 가이드를 따르면 대부분의 Vercel 빌드 이슈가 사라집니다.

### 10.1 검증된 Vercel 설정

| 항목 | 설정값 | 이유 |
|------|--------|------|
| **Node.js** | `20.x` 고정 | 최신 LTS, 안정성 |
| **패키지 매니저** | `pnpm` | 더 빠르고 효율적 |
| **Build Command** | `pnpm build` | pnpm 사용 |
| **Install Command** | `pnpm i --frozen-lockfile` | 정확한 버전 설치 |
| **Output Directory** | `.next` (기본값) | Next.js 기본 |

### 10.2 네이티브 모듈 회피

#### ❌ 사용 금지 패키지
- `bcrypt` → `bcryptjs`로 교체
- `sharp` → Next/Image 클라우드 최적화 사용
- `canvas` → 서버리스 환경 비호환
- `node-sass` → `sass`로 교체

#### ✅ 최적화된 Next.js 설정
```javascript
// next.config.js
const nextConfig = {
  output: 'standalone',
  reactStrictMode: true,
  swcMinify: true,
  transpilePackages: ['recharts'],
  experimental: {
    serverActions: { 
      allowedOrigins: ['*'],
      bodySizeLimit: '2mb'
    }
  }
};
```

### 10.3 필수 파일 구조
```
프로젝트/
├── .npmrc              # shamefully-hoist=true
├── pnpm-lock.yaml     # pnpm 락파일 (필수!)
├── package.json       # node >=20.0.0
├── next.config.js     # 최적화 설정
└── vercel.json       # 최소 설정
```

### 10.4 빌드 에러 해결

| 에러 | 해결책 |
|------|--------|
| "Module not found" | `pnpm install` 재실행 |
| "self is not defined" | Dynamic import with `ssr: false` |
| "Out of memory" | `swcMinify: true` 설정 |
| Sharp 관련 | Next/Image 사용 |

### 10.5 성과 지표

| 항목 | Before | After |
|------|--------|-------|
| **빌드 성공률** | ~60% | ~95% |
| **빌드 시간** | 3-5분 | 1-2분 |
| **번들 크기** | 크다 | 작다 |

### 10.6 대안: Docker/NAS 배포

Vercel 빌드 에러가 지속되는 경우, **Synology NAS + Portainer** 조합 추천:
- 빌드 에러 없음
- 완전한 제어권
- 비용 절감 (호스팅 무료)
- 제한 없음 (Cron, 메모리 등)

## 11. 개발 지침

### 11.1 반복 개발 프로세스
- 문서 참조: [ITERATIVE_DEVELOPMENT.md](./ITERATIVE_DEVELOPMENT.md)
- PRD 우선: 모든 구현은 이 PRD를 기준으로 함
- 변경사항 문서화: 새로운 요구사항은 먼저 문서에 반영

### 11.2 데이터베이스 스키마
- ERD 참조: [DATABASE_ERD.md](./DATABASE_ERD.md)
- 마이그레이션: scripts/init-database.sql 사용
- RLS 정책: 모든 테이블에 Row Level Security 적용

### 11.3 환경 변수
```bash
# .env.local
NEXT_PUBLIC_SUPABASE_URL=<your-supabase-url>
NEXT_PUBLIC_SUPABASE_API_KEY=<public-api-key>
SUPABASE_API_KEY=<service-role-key>
APP_URL=http://localhost:8081
```

---

## 12. 관련 문서 상세

### 12.1 시스템 초기화 프로세스 ⭐

**데이터베이스 초기화 순서 (필수)**:
1. **스키마 초기화**: `/scripts/01.working_schema_reset.sql` 실행
   - 모든 테이블 및 타입 재생성
   - 기본 데이터 삽입 (카테고리, 출납유형, 환율, 시스템 설정)
   - 트리거 및 함수 생성

2. **관리자 계정 생성**: `/scripts/02.create_admin_helper.sql` 실행
   - Supabase Dashboard에서 먼저 auth.users에 계정 생성
   - 스크립트를 통해 user_profiles에 관리자 프로필 생성
   - 시스템 준비 상태 확인

3. **테스트 데이터 생성**: `/scripts/03.test_data.sql` 실행
   - 샘플 상품, 주문, 재고 데이터 생성
   - order_items에 상품 정보 직접 저장 (product_name 포함)
   - 다양한 주문 상태 테스트 데이터

**참조**: [SETUP_GUIDE.md](./SETUP_GUIDE.md)
- Supabase 프로젝트 설정
- Storage 버킷 설정
- Realtime 설정

### 12.2 배포 프로세스
**참조**: [DEPLOYMENT_GUIDE.md](./DEPLOYMENT_GUIDE.md)
- Vercel 배포 (권장)
- Docker 배포 (대안)
- 환경 변수 설정
- CI/CD 파이프라인
- 도메인 및 SSL 설정

### 12.3 유지보수 및 운영
**참조**: [MAINTENANCE_GUIDE.md](./MAINTENANCE_GUIDE.md)
- 데이터 초기화 방법
- 사용자 관리
- 백업 및 복구
- 정기 유지보수 작업
- 성능 모니터링
- 트러블슈팅

### 12.4 반복적 개발 프로세스
**참조**: [ITERATIVE_DEVELOPMENT.md](./ITERATIVE_DEVELOPMENT.md)
- 개발 사이클 (Discovery → Documentation → Implementation → Validation → Deployment)
- 커밋 메시지 컨벤션
- 문서 우선 개발
- 테스트 전략
- 릴리스 스케줄

### 12.5 데이터베이스 스키마
**참조**: [DATABASE_ERD.md](./DATABASE_ERD.md)

#### 핵심 테이블 구조 (실제 구현 기준)
- **user_profiles** (사용자): 사용자 관리 및 권한
- **products** (상품): SKU 자동생성, 이미지 URL 지원
- **orders** (주문): 주문번호 자동생성, 상태 관리
- **order_items** (주문상품): 다중 상품 지원
- **shipments** (배송): 이중 배송 시스템 (별도 테이블)
- **system_settings** (시스템 설정): 재고 부족 임계값 등 전역 설정
- **inventory_movements** (재고이동): 입출고 이력
- **cashbook_transactions** (출납장부): 재무 기록
- **categories** (카테고리): 상품 분류 관리
- **event_logs** (이벤트로그): 감사 추적
- **sequence_counters** (시퀀스): 주문번호 생성용

#### 시스템 기본 카테고리 (필수)
상품 카테고리는 시스템 초기화시 다음 8개 브랜드가 기본으로 생성됩니다:

| 코드 | 한국어 | 중국어 | 설명 |
|------|--------|--------|------|
| `louis_vuitton` | Louis Vuitton | 路易威登 | 프랑스 명품 브랜드 |
| `gucci` | Gucci | 古驰 | 이탈리아 명품 브랜드 |
| `chanel` | Chanel | 香奈儿 | 프랑스 명품 브랜드 |
| `hermes` | Hermes | 爱马仕 | 프랑스 명품 브랜드 |
| `burberry` | Burberry | 博柏利 | 영국 명품 브랜드 |
| `prada` | Prada | 普拉达 | 이탈리아 명품 브랜드 |
| `dior` | Dior | 迪奥 | 프랑스 명품 브랜드 |
| `balenciaga` | Balenciaga | 巴黎世家 | 스페인/프랑스 명품 브랜드 |
| `other` | 기타 | 其他 | 기타 브랜드 및 상품 |

**Note**: 시스템 카테고리는 삭제 불가능하며, 관리자가 추가 카테고리를 생성할 수 있습니다.

### 12.6 테스트 데이터 관리
**대량 테스트 데이터 생성**
```bash
# 페이지네이션 및 성능 테스트용 대량 데이터 생성
# 파일: scripts/generate-test-data.sql
# 생성 데이터: 10개 카테고리, 100개 상품, 100개 주문, 200+ 주문 아이템

# Supabase Dashboard SQL Editor에서 실행
# 또는 psql 명령어 사용:
psql $DATABASE_URL -f scripts/generate-test-data.sql
```

**⚠️ 주의사항**:
- 이 스크립트는 모든 기존 데이터를 TRUNCATE합니다
- 개발/테스트 환경에서만 사용하세요
- 운영 환경에서는 절대 실행하지 마세요

### 12.7 E2E 테스트 도구
**E2E 테스트 프레임워크 선택**
- **Playwright** (권장): 현대적인 E2E 테스트 프레임워크
  - 크로스 브라우저 지원 (Chrome, Firefox, Safari)
  - 강력한 디버깅 도구와 트레이싱 기능
  - 테스트 위치: `/e2e/` 디렉토리
  - 실행: `pnpm test:e2e` 또는 `npx playwright test`
- **Puppeteer** (대안): 간단한 Chrome 자동화
  - Chrome/Chromium 전용
  - 빠른 프로토타이핑과 간단한 테스트에 적합
  - 독립 실행 가능한 Node.js 스크립트로 작성

---

## 13. 프로젝트 현황 요약 (2025-09-07)

### ✅ 완료된 작업
- 기본 테이블 구조 및 RLS 정책
- 주문/재고/배송 기본 CRUD
- 사용자 인증 및 권한 관리
- 대시보드 기본 구성

### 🚧 진행 중
- shipments 테이블 실제 구현 확인
- 이중 배송 시스템 완성
- 이미지 업로드 기능 구현
- 성능 최적화

### 📋 TODO
- orders 테이블의 배송 필드 → shipments 테이블로 완전 이관
- 테이블명 통일 (user_profiles)
- PWA 지원
- 실시간 알림
- CSV 일괄 업로드
