# YUANDI ERP 비즈니스 플로우 & 데이터 검증 가이드

> 모든 비즈니스 프로세스의 데이터 흐름과 검증 포인트를 정리한 문서입니다.
> 각 작업 시 어떤 테이블의 어떤 필드가 업데이트되고, 무엇을 확인해야 하는지 명시합니다.

## 📌 버전 히스토리

| 버전 | 날짜 | 작성자 | 주요 변경사항 |
|------|------|--------|--------------|
| v1.0 | 2025-01-10 | YUANDI ERP Dev Team | - 초기 문서 작성<br>- 전체 비즈니스 플로우 정리<br>- 데이터 업데이트 필드 명세<br>- 검증 포인트 및 SQL 쿼리 추가<br>- 트러블슈팅 가이드 포함 |

## 📋 목차
1. [재고 관리](#1-재고-관리)
2. [주문 관리](#2-주문-관리)
3. [배송 관리](#3-배송-관리)
4. [출납장부](#4-출납장부)
5. [대시보드](#5-대시보드)

---

## 1. 재고 관리

### 1.1 상품 등록 (모달: 신규 상품 등록)

#### 데이터 플로우:
```
사용자 입력 → products 테이블 INSERT → inventory_movements 기록 → 재고 목록 갱신
```

#### 업데이트 필드:
**products 테이블:**
- `name`: 상품명 (필수)
- `category`: 카테고리 (필수)
- `model`: 모델명 (필수)
- `color`: 색상 (선택)
- `brand`: 브랜드 (선택)
- `sku`: 자동 생성 ([Category]-[Model]-[Color]-[Brand]-[HASH5])
- `cost_cny`: 원가 (필수)
- `price_krw`: 판매가 (필수)
- `on_hand`: 초기 재고 수량 (필수, 기본값 1)
- `low_stock_threshold`: 재고 부족 임계값 (기본값 5)
- `is_active`: true (기본값)
- `created_at`: 현재 시간
- `updated_at`: 현재 시간

**inventory_movements 테이블:**
- `product_id`: 생성된 상품 ID
- `movement_type`: 'inbound'
- `quantity`: 초기 재고 수량
- `balance_before`: 0
- `balance_after`: 초기 재고 수량
- `note`: '초기 재고'
- `movement_date`: 현재 시간
- `created_by`: 로그인 사용자 ID

#### 검증 포인트:
1. **필수 필드 확인**: name, category, model, cost_cny, price_krw
2. **SKU 중복 확인**: 생성된 SKU가 기존 상품과 중복되지 않는지
3. **가격 유효성**: cost_cny > 0, price_krw > 0
4. **재고 수량**: on_hand >= 0

#### 확인 방법:
```sql
-- 상품 생성 확인
SELECT * FROM products WHERE id = '생성된_상품_ID';

-- 재고 이동 내역 확인
SELECT * FROM inventory_movements 
WHERE product_id = '생성된_상품_ID' 
ORDER BY created_at DESC;
```

---

### 1.2 재고 입고 (모달: 재고 입고)

#### 데이터 플로우:
```
입고 정보 입력 → products.on_hand 증가 → inventory_movements 기록 → cashbook_transactions 기록 → 재고 목록 갱신
```

#### 업데이트 필드:
**products 테이블:**
- `on_hand`: 기존값 + 입고수량
- `updated_at`: 현재 시간

**inventory_movements 테이블:**
- `product_id`: 대상 상품 ID
- `movement_type`: 'inbound'
- `quantity`: 입고 수량 (양수)
- `balance_before`: 입고 전 재고
- `balance_after`: 입고 후 재고
- `unit_cost`: 단가 (선택)
- `total_cost`: 단가 × 수량
- `note`: 입고 메모
- `movement_date`: 현재 시간
- `created_by`: 로그인 사용자 ID

**cashbook_transactions 테이블:**
- `transaction_date`: 현재 날짜
- `type`: 'inbound'
- `amount`: 총 비용 (단가 × 수량)
- `amount_krw`: 총 비용
- `currency`: 'KRW'
- `description`: '[상품명] 재고 입고 (수량개)'
- `ref_type`: 'inventory_movement'
- `ref_id`: movement ID
- `created_by`: 로그인 사용자 ID

#### 검증 포인트:
1. **재고 증가 확인**: products.on_hand가 정확히 증가했는지
2. **잔량 계산**: balance_after = balance_before + quantity
3. **출납장부 기록**: 지출 금액이 정확히 기록되었는지

#### 확인 방법:
```sql
-- 재고 확인
SELECT on_hand FROM products WHERE id = '상품_ID';

-- 재고 이동 내역
SELECT * FROM inventory_movements 
WHERE product_id = '상품_ID' 
ORDER BY created_at DESC LIMIT 1;

-- 출납장부 확인
SELECT * FROM cashbook_transactions 
WHERE ref_type = 'inventory_movement' 
AND ref_id = 'movement_ID';
```

---

### 1.3 재고 조정 (버튼: 재고 조정)

#### 데이터 플로우:
```
조정 수량 입력 → products.on_hand 조정 → inventory_movements 기록 → 재고 목록 갱신
```

#### 업데이트 필드:
**products 테이블:**
- `on_hand`: 기존값 + 조정수량 (음수 가능)
- `updated_at`: 현재 시간

**inventory_movements 테이블:**
- `product_id`: 대상 상품 ID
- `movement_type`: 'adjustment'
- `quantity`: 조정 수량 (양수/음수)
- `balance_before`: 조정 전 재고
- `balance_after`: 조정 후 재고
- `note`: 조정 사유
- `movement_date`: 현재 시간
- `created_by`: 로그인 사용자 ID

#### 검증 포인트:
1. **재고 음수 방지**: balance_after >= 0
2. **조정 사유 필수**: note 필드 필수 입력

---

## 2. 주문 관리

### 2.1 주문 생성 (페이지: 주문 관리 → 신규 주문)

#### 데이터 플로우:
```
주문 정보 입력 → orders 테이블 INSERT → order_items INSERT → 
products.on_hand 감소 → inventory_movements 기록 → 
cashbook_transactions 기록 (수입) → event_logs 기록 → 대시보드 갱신
```

#### 업데이트 필드:
**orders 테이블:**
- `order_number`: 'ORD-YYMMDD-###' (일별 순번)
- `customer_name`: 고객명
- `customer_phone`: 전화번호
- `customer_messenger_id`: 메신저 ID (선택)
- `status`: 'paid' (기본값)
- `total_krw`: 총 금액
- `shipping_address_line1`: 주소
- `shipping_address_line2`: 상세주소
- `shipping_postal_code`: 우편번호
- `payment_method`: 결제 방법
- `notes`: 주문 메모
- `created_at`: 현재 시간
- `created_by`: 로그인 사용자 ID

**order_items 테이블:**
- `order_id`: 생성된 주문 ID
- `product_id`: 상품 ID
- `sku`: 상품 SKU (비정규화)
- `product_name`: 상품명 (비정규화)
- `product_category`: 카테고리 (비정규화)
- `product_model`: 모델 (비정규화)
- `product_color`: 색상 (비정규화)
- `product_brand`: 브랜드 (비정규화)
- `quantity`: 주문 수량
- `unit_price_krw`: 단가
- `total_price_krw`: 단가 × 수량

**products 테이블:**
- `on_hand`: 기존값 - 주문수량

**inventory_movements 테이블:**
- `product_id`: 상품 ID
- `movement_type`: 'sale'
- `quantity`: -주문수량 (음수)
- `balance_before`: 판매 전 재고
- `balance_after`: 판매 후 재고
- `note`: '주문 #주문번호'
- `movement_date`: 현재 시간
- `created_by`: 로그인 사용자 ID

**cashbook_transactions 테이블:**
- `transaction_date`: 현재 날짜
- `type`: 'sale'
- `amount`: 주문 총액
- `amount_krw`: 주문 총액
- `currency`: 'KRW'
- `description`: '주문 판매 수익 - 주문번호 (고객명)'
- `reference_type`: 'order'
- `reference_id`: 주문 ID
- `created_by`: 로그인 사용자 ID

**event_logs 테이블:**
- `entity_type`: 'order'
- `entity_id`: 주문 ID
- `action`: 'created'
- `details`: 주문 상세 정보 JSON
- `user_id`: 로그인 사용자 ID

#### 검증 포인트:
1. **재고 확인**: products.on_hand >= 주문수량
2. **주문번호 중복**: 같은 날짜에 동일 번호 없음
3. **재고 감소**: products.on_hand가 정확히 감소
4. **금액 계산**: total_krw = Σ(unit_price_krw × quantity)
5. **출납장부 잔액**: 이전 잔액 + 주문 금액

#### 확인 방법:
```sql
-- 주문 확인
SELECT * FROM orders WHERE id = '주문_ID';

-- 주문 아이템 확인
SELECT * FROM order_items WHERE order_id = '주문_ID';

-- 재고 감소 확인
SELECT on_hand FROM products WHERE id = '상품_ID';

-- 재고 이동 내역
SELECT * FROM inventory_movements 
WHERE note LIKE '%주문번호%';

-- 출납장부 확인
SELECT * FROM cashbook_transactions 
WHERE reference_type = 'order' AND reference_id = '주문_ID';
```

---

### 2.2 주문 상태 변경

#### 2.2.1 배송 중 (paid → shipped)

#### 데이터 플로우:
```
상태 변경 → orders.status = 'shipped' → orders.shipped_at 기록 → 
shipments 테이블 생성/업데이트 → event_logs 기록
```

#### 업데이트 필드:
**orders 테이블:**
- `status`: 'shipped'
- `shipped_at`: 현재 시간
- `updated_at`: 현재 시간

**shipments 테이블:**
- `order_id`: 주문 ID
- `tracking_number_kr`: 한국 운송장 번호
- `tracking_number_cn`: 중국 운송장 번호
- `carrier_kr`: 한국 택배사
- `carrier_cn`: 중국 택배사
- `status`: 'in_transit'
- `shipped_date`: 현재 날짜
- `created_at`: 현재 시간

**event_logs 테이블:**
- `entity_type`: 'order'
- `entity_id`: 주문 ID
- `action`: 'shipped'
- `details`: 배송 정보 JSON

---

#### 2.2.2 배송 완료 (shipped → done)

#### 업데이트 필드:
**orders 테이블:**
- `status`: 'done'
- `delivered_at`: 현재 시간

**shipments 테이블:**
- `status`: 'delivered'
- `delivered_date`: 현재 날짜

---

#### 2.2.3 환불 (any → refunded)

#### 데이터 플로우:
```
환불 처리 → orders.status = 'refunded' → products.on_hand 복구 → 
inventory_movements 기록 → cashbook_transactions 기록 (지출) → 
inventory.allocated 감소 → event_logs 기록
```

#### 업데이트 필드:
**orders 테이블:**
- `status`: 'refunded'
- `updated_at`: 현재 시간

**products 테이블:**
- `on_hand`: 기존값 + 환불수량 (재고 복구)

**inventory 테이블:**
- `allocated`: 기존값 - 환불수량

**inventory_movements 테이블:**
- `product_id`: 상품 ID
- `movement_type`: 'adjustment'
- `quantity`: +환불수량 (양수, 재고 증가)
- `balance_before`: 복구 전 재고
- `balance_after`: 복구 후 재고
- `note`: '주문 환불 #주문ID'

**cashbook_transactions 테이블:**
- `type`: 'refund'
- `amount`: -환불금액 (지출)
- `description`: '주문 환불 - 주문번호 (고객명)'

#### 검증 포인트:
1. **재고 복구**: products.on_hand 증가 확인
2. **출납장부**: 환불 금액이 지출로 기록
3. **할당량 감소**: inventory.allocated 감소

---

## 3. 배송 관리

### 3.1 배송 정보 등록/수정

#### 데이터 플로우:
```
운송장 번호 입력 → shipments 테이블 INSERT/UPDATE → orders.status 업데이트 → event_logs 기록
```

#### 업데이트 필드:
**shipments 테이블:**
- `tracking_number_kr`: 한국 운송장 번호
- `tracking_number_cn`: 중국 운송장 번호
- `carrier_kr`: 한국 택배사
- `carrier_cn`: 중국 택배사
- `status`: 'pending'/'in_transit'/'delivered'
- `shipped_date`: 발송일
- `delivered_date`: 배송완료일
- `notes`: 배송 메모

---

## 4. 출납장부

### 4.1 거래 내역 자동 기록

#### 자동 기록 시점:
1. **수입 (+)**
   - 주문 생성 시 (type: 'sale')
   - 기타 수입 등록 시 (type: 'other_income')

2. **지출 (-)**
   - 재고 입고 시 (type: 'inbound')
   - 주문 환불 시 (type: 'refund')
   - 기타 지출 등록 시 (type: 'other_expense')

#### 필수 필드:
**cashbook_transactions 테이블:**
- `transaction_date`: 거래 날짜
- `type`: 거래 유형
- `amount`: 금액 (원화)
- `amount_krw`: 원화 환산 금액
- `currency`: 통화 (KRW/CNY/USD)
- `fx_rate`: 환율 (기본 1.0)
- `balance_krw`: 현재 잔액 (이전 잔액 + 금액)
- `description`: 거래 설명
- `reference_type`: 참조 유형 (order/inventory_movement)
- `reference_id`: 참조 ID
- `created_by`: 작성자

#### 검증 포인트:
1. **잔액 연속성**: 각 거래의 balance_krw = 이전 balance_krw + amount_krw
2. **참조 무결성**: reference_id가 실제 존재하는 레코드
3. **환율 적용**: CNY/USD 거래 시 fx_rate 적용 확인

---

## 5. 대시보드

### 5.1 실시간 통계 갱신

#### 갱신 트리거:
- 주문 생성/수정/삭제
- 재고 입고/조정
- 배송 상태 변경

#### 표시 데이터:
**오늘 통계:**
- 오늘 주문 수: `COUNT(*) WHERE DATE(created_at) = TODAY AND status != 'cancelled'`
- 오늘 매출: `SUM(total_krw) WHERE DATE(created_at) = TODAY AND status != 'cancelled'`

**이번 달 통계:**
- 월 주문 수: `COUNT(*) WHERE MONTH(created_at) = THIS_MONTH`
- 월 매출: `SUM(total_krw) WHERE MONTH(created_at) = THIS_MONTH`

**재고 통계:**
- 총 상품 수: `COUNT(*) FROM products WHERE is_active = true`
- 재고 부족: `COUNT(*) WHERE on_hand <= low_stock_threshold`

**배송 통계:**
- 배송 대기: `COUNT(*) WHERE status = 'paid'`
- 배송 중: `COUNT(*) WHERE status = 'shipped'`

---

## 6. 시스템 로그 & 감사

### 6.1 Event Logs

모든 중요 작업은 event_logs 테이블에 기록:

#### 기록 대상:
- 주문 생성/수정/삭제
- 재고 입고/조정
- 상품 등록/수정
- 사용자 로그인/로그아웃
- 권한 변경

#### 필드:
- `entity_type`: 엔티티 유형 (order/product/user)
- `entity_id`: 엔티티 ID
- `action`: 작업 (created/updated/deleted)
- `details`: 상세 정보 JSON
- `user_id`: 작업 사용자
- `created_at`: 작업 시간

---

## 7. 데이터 정합성 검증 SQL

### 일일 검증 체크리스트:

```sql
-- 1. 재고 이동 내역과 실제 재고 일치 확인
SELECT 
  p.id,
  p.name,
  p.on_hand as current_stock,
  COALESCE(
    (SELECT balance_after 
     FROM inventory_movements 
     WHERE product_id = p.id 
     ORDER BY created_at DESC 
     LIMIT 1), 0
  ) as last_balance
FROM products p
WHERE p.on_hand != COALESCE(
  (SELECT balance_after 
   FROM inventory_movements 
   WHERE product_id = p.id 
   ORDER BY created_at DESC 
   LIMIT 1), 0
);

-- 2. 출납장부 잔액 연속성 확인
SELECT 
  t1.id,
  t1.transaction_date,
  t1.balance_krw as current_balance,
  t2.balance_krw + t1.amount_krw as calculated_balance
FROM cashbook_transactions t1
LEFT JOIN cashbook_transactions t2 ON t2.id = (
  SELECT id FROM cashbook_transactions 
  WHERE created_at < t1.created_at 
  ORDER BY created_at DESC 
  LIMIT 1
)
WHERE t1.balance_krw != (t2.balance_krw + t1.amount_krw);

-- 3. 주문 총액과 아이템 합계 일치 확인
SELECT 
  o.id,
  o.order_number,
  o.total_krw as order_total,
  SUM(oi.total_price_krw) as items_total
FROM orders o
JOIN order_items oi ON oi.order_id = o.id
GROUP BY o.id, o.order_number, o.total_krw
HAVING o.total_krw != SUM(oi.total_price_krw);

-- 4. 재고 부족 상품 확인
SELECT 
  id,
  name,
  on_hand,
  low_stock_threshold
FROM products
WHERE on_hand <= low_stock_threshold
AND is_active = true;
```

---

## 8. 트러블슈팅 가이드

### 문제: 재고가 음수가 됨
**원인**: 주문 시 재고 확인 누락
**해결**: 
1. products.on_hand를 0 이상으로 조정
2. inventory_movements에 조정 기록 추가
3. 주문 생성 시 재고 확인 로직 추가

### 문제: 출납장부 잔액 불일치
**원인**: 동시 거래 처리 시 잔액 계산 오류
**해결**:
1. 트랜잭션 사용하여 순차 처리
2. 잔액 재계산 스크립트 실행
3. cashbook_transactions 테이블 락 사용

### 문제: 주문번호 중복
**원인**: 동시 주문 생성
**해결**:
1. 주문번호 생성 시 트랜잭션 사용
2. UNIQUE 제약조건 추가
3. 재시도 로직 구현

---

## 9. 성능 최적화 포인트

### 인덱스 필수 컬럼:
- orders.order_number
- orders.status
- orders.created_at
- products.sku
- inventory_movements.product_id
- inventory_movements.created_at
- cashbook_transactions.created_at
- shipments.order_id

### 비정규화 권장:
- order_items에 상품 정보 복사 (이미 구현됨)
- 대시보드용 집계 테이블 생성 고려

---

## 10. 보안 체크포인트

### 권한 검증:
- **admin**: 모든 기능 접근 가능
- **order_manager**: 주문/재고 관리
- **ship_manager**: 배송 관리만

### 민감 정보:
- 고객 전화번호: 마스킹 처리
- 금액 정보: 권한별 표시
- 로그인 정보: 암호화 저장

