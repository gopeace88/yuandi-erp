# (250907-v1.0)MAINTENANCE_GUIDE.md — 데이터 관리 및 유지보수 가이드

## 버전 히스토리

| 버전 | 날짜 | 작성자 | 변경사항 |
|------|------|--------|----------|
| v1.0 | 2025-09-07 | 개발팀 | 최초 작성, 데이터 관리 및 유지보수 가이드 |

---

## 📊 데이터 관리

### 1. 데이터 초기화 방법

#### 1.1 완전 초기화 (모든 데이터 삭제)

**⚠️ 주의: 모든 데이터가 삭제됩니다!**

```sql
-- Supabase SQL Editor에서 실행
-- 1. Foreign Key 제약 때문에 순서대로 삭제

-- 거래 데이터 삭제
DELETE FROM cashbook_transactions;
DELETE FROM inventory_logs;

-- 배송 데이터 삭제
DELETE FROM shipments;

-- 주문 데이터 삭제
DELETE FROM order_items;
DELETE FROM orders;

-- 상품 데이터 삭제
DELETE FROM products;

-- 이벤트 로그 삭제
DELETE FROM event_logs;

-- 사용자 프로필 삭제 (auth.users는 별도 삭제 필요)
DELETE FROM user_profiles;

-- 시퀀스 리셋 (선택사항)
ALTER SEQUENCE orders_id_seq RESTART WITH 1;
ALTER SEQUENCE products_id_seq RESTART WITH 1;
```

#### 1.2 부분 초기화 (사용자 정보 유지)

```sql
-- 주문/거래 데이터만 삭제 (사용자 정보 유지)
BEGIN;

-- 거래 관련 데이터 삭제
DELETE FROM cashbook_transactions;
DELETE FROM inventory_logs;
DELETE FROM shipments;
DELETE FROM order_items;
DELETE FROM orders;

-- 상품 재고 리셋
UPDATE products SET on_hand = 0;

-- 이벤트 로그는 선택적 삭제
DELETE FROM event_logs WHERE created_at < NOW() - INTERVAL '30 days';

COMMIT;
```

#### 1.3 테스트 데이터 생성

```sql
-- scripts/generate-test-data.sql 실행
-- 또는 Node.js 스크립트 사용
node scripts/generate-test-data.js
```

### 2. 사용자 관리

#### 2.1 새 사용자 추가

```sql
-- 1. Supabase Dashboard에서 auth.users 생성
-- Authentication > Users > Invite user

-- 2. user_profiles에 프로필 추가
INSERT INTO user_profiles (id, email, name, role, active)
VALUES (
  'auth.users의 UUID',
  'user@example.com',
  '사용자명',
  'ORDER_MANAGER', -- ADMIN, ORDER_MANAGER, SHIP_MANAGER
  true
);
```

#### 2.2 사용자 권한 변경

```sql
-- 권한 변경
UPDATE user_profiles 
SET role = 'ADMIN' 
WHERE email = 'user@example.com';

-- 사용자 비활성화
UPDATE user_profiles 
SET active = false 
WHERE email = 'user@example.com';
```

#### 2.3 사용자 삭제

```sql
-- 특정 사용자의 모든 데이터 삭제
DO $$
DECLARE
  target_user_id UUID := 'user-uuid-here';
BEGIN
  -- 관련 데이터 먼저 삭제
  DELETE FROM cashbook_transactions WHERE created_by = target_user_id;
  DELETE FROM shipments WHERE created_by = target_user_id;
  DELETE FROM order_items WHERE order_id IN (
    SELECT id FROM orders WHERE created_by = target_user_id
  );
  DELETE FROM orders WHERE created_by = target_user_id;
  DELETE FROM inventory_logs WHERE created_by = target_user_id;
  DELETE FROM products WHERE created_by = target_user_id;
  
  -- 마지막으로 프로필 삭제
  DELETE FROM user_profiles WHERE id = target_user_id;
  
  -- auth.users는 Dashboard에서 삭제
END $$;
```

### 3. 백업 및 복구

#### 3.1 자동 백업 (Supabase)

Supabase는 다음을 자동으로 제공:
- Point-in-time Recovery (Pro 플랜)
- 일일 백업 (Free 플랜: 7일, Pro: 30일)

#### 3.2 수동 백업

```bash
# pg_dump를 사용한 백업
pg_dump -h db.your-project.supabase.co \
  -U postgres \
  -d postgres \
  -f backup_$(date +%Y%m%d).sql

# 특정 테이블만 백업
pg_dump -h db.your-project.supabase.co \
  -U postgres \
  -d postgres \
  -t orders -t products \
  -f partial_backup.sql
```

#### 3.3 데이터 내보내기 (Excel)

```bash
# API를 통한 Excel 내보내기
curl -H "Authorization: Bearer YOUR_TOKEN" \
  https://your-app.vercel.app/api/export/orders.xlsx \
  -o orders_$(date +%Y%m%d).xlsx
```

### 4. 정기 유지보수

#### 4.1 일일 작업

```sql
-- 오래된 이벤트 로그 정리 (30일 이상)
DELETE FROM event_logs 
WHERE created_at < NOW() - INTERVAL '30 days';

-- 세션 정리
DELETE FROM auth.sessions 
WHERE expires_at < NOW();
```

#### 4.2 주간 작업

```sql
-- 데이터베이스 통계 업데이트
ANALYZE;

-- 인덱스 재구성
REINDEX TABLE orders;
REINDEX TABLE products;

-- 미사용 상품 비활성화
UPDATE products 
SET active = false 
WHERE on_hand = 0 
  AND id NOT IN (
    SELECT DISTINCT product_id 
    FROM order_items 
    WHERE created_at > NOW() - INTERVAL '90 days'
  );
```

#### 4.3 월간 작업

```sql
-- 데이터베이스 최적화
VACUUM ANALYZE;

-- 오래된 완료 주문 아카이브 (선택사항)
INSERT INTO orders_archive 
SELECT * FROM orders 
WHERE status = 'DONE' 
  AND created_at < NOW() - INTERVAL '6 months';

DELETE FROM orders 
WHERE status = 'DONE' 
  AND created_at < NOW() - INTERVAL '6 months';
```

### 5. 성능 모니터링

#### 5.1 느린 쿼리 찾기

```sql
-- 느린 쿼리 확인
SELECT 
  query,
  calls,
  mean_exec_time,
  total_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;
```

#### 5.2 테이블 크기 확인

```sql
-- 테이블 크기 확인
SELECT 
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

#### 5.3 인덱스 사용률 확인

```sql
-- 인덱스 사용률
SELECT 
  schemaname,
  tablename,
  indexname,
  idx_scan,
  idx_tup_read,
  idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

### 6. 트러블슈팅

#### 6.1 Foreign Key 제약 오류

```sql
-- 고아 데이터 찾기
SELECT * FROM orders 
WHERE created_by NOT IN (SELECT id FROM user_profiles);

-- 고아 데이터 정리
DELETE FROM orders 
WHERE created_by NOT IN (SELECT id FROM user_profiles);
```

#### 6.2 중복 데이터 제거

```sql
-- 중복 주문 찾기
SELECT customer_phone, COUNT(*) 
FROM orders 
WHERE created_at > NOW() - INTERVAL '1 day'
GROUP BY customer_phone 
HAVING COUNT(*) > 1;

-- 중복 제거 (최신 것만 유지)
DELETE FROM orders a
USING orders b
WHERE a.customer_phone = b.customer_phone
  AND a.created_at < b.created_at;
```

#### 6.3 재고 불일치 수정

```sql
-- 재고 재계산
UPDATE products p
SET on_hand = (
  SELECT COALESCE(SUM(
    CASE 
      WHEN type IN ('INBOUND', 'RETURN') THEN quantity
      WHEN type IN ('SALE', 'ADJUSTMENT') THEN -quantity
    END
  ), 0)
  FROM inventory_logs
  WHERE product_id = p.id
);
```

### 7. 보안 관리

#### 7.1 RLS (Row Level Security) 점검

```sql
-- RLS 정책 확인
SELECT 
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual
FROM pg_policies
WHERE schemaname = 'public';
```

#### 7.2 권한 검토

```sql
-- 테이블 권한 확인
SELECT 
  grantee,
  table_name,
  privilege_type
FROM information_schema.role_table_grants
WHERE table_schema = 'public';
```

### 8. 스크립트 자동화

#### 8.1 Cron Job 설정 (Vercel)

```javascript
// api/cron/daily-cleanup.ts
export async function GET(request: Request) {
  // Cron Secret 검증
  const authHeader = request.headers.get('authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return new Response('Unauthorized', { status: 401 });
  }

  // 일일 정리 작업
  await cleanupOldLogs();
  await updateStatistics();
  
  return Response.json({ success: true });
}
```

#### 8.2 백업 스크립트

```bash
#!/bin/bash
# scripts/backup.sh

DATE=$(date +%Y%m%d)
BACKUP_DIR="/backups"

# 데이터베이스 백업
pg_dump $DATABASE_URL > $BACKUP_DIR/db_$DATE.sql

# 파일 압축
gzip $BACKUP_DIR/db_$DATE.sql

# 오래된 백업 삭제 (30일 이상)
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete
```

## 📚 참고 문서

- [Supabase Database Functions](https://supabase.com/docs/guides/database/functions)
- [PostgreSQL Maintenance](https://www.postgresql.org/docs/current/maintenance.html)
- [Next.js API Routes](https://nextjs.org/docs/api-routes/introduction)