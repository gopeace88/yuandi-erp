# (250907-v1.0)MAINTENANCE_GUIDE.md â€” ë°ì´í„° ê´€ë¦¬ ë° ìœ ì§€ë³´ìˆ˜ ê°€ì´ë“œ

## ë²„ì „ íˆìŠ¤í† ë¦¬

| ë²„ì „ | ë‚ ì§œ | ì‘ì„±ì | ë³€ê²½ì‚¬í•­ |
|------|------|--------|----------|
| v1.0 | 2025-09-07 | ê°œë°œíŒ€ | ìµœì´ˆ ì‘ì„±, ë°ì´í„° ê´€ë¦¬ ë° ìœ ì§€ë³´ìˆ˜ ê°€ì´ë“œ |

---

## ğŸ“Š ë°ì´í„° ê´€ë¦¬

### 1. ë°ì´í„° ì´ˆê¸°í™” ë°©ë²•

#### 1.1 ì™„ì „ ì´ˆê¸°í™” (ëª¨ë“  ë°ì´í„° ì‚­ì œ)

**âš ï¸ ì£¼ì˜: ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤!**

```sql
-- Supabase SQL Editorì—ì„œ ì‹¤í–‰
-- 1. Foreign Key ì œì•½ ë•Œë¬¸ì— ìˆœì„œëŒ€ë¡œ ì‚­ì œ

-- ê±°ë˜ ë°ì´í„° ì‚­ì œ
DELETE FROM cashbook_transactions;
DELETE FROM inventory_logs;

-- ë°°ì†¡ ë°ì´í„° ì‚­ì œ
DELETE FROM shipments;

-- ì£¼ë¬¸ ë°ì´í„° ì‚­ì œ
DELETE FROM order_items;
DELETE FROM orders;

-- ìƒí’ˆ ë°ì´í„° ì‚­ì œ
DELETE FROM products;

-- ì´ë²¤íŠ¸ ë¡œê·¸ ì‚­ì œ
DELETE FROM event_logs;

-- ì‚¬ìš©ì í”„ë¡œí•„ ì‚­ì œ (auth.usersëŠ” ë³„ë„ ì‚­ì œ í•„ìš”)
DELETE FROM user_profiles;

-- ì‹œí€€ìŠ¤ ë¦¬ì…‹ (ì„ íƒì‚¬í•­)
ALTER SEQUENCE orders_id_seq RESTART WITH 1;
ALTER SEQUENCE products_id_seq RESTART WITH 1;
```

#### 1.2 ë¶€ë¶„ ì´ˆê¸°í™” (ì‚¬ìš©ì ì •ë³´ ìœ ì§€)

```sql
-- ì£¼ë¬¸/ê±°ë˜ ë°ì´í„°ë§Œ ì‚­ì œ (ì‚¬ìš©ì ì •ë³´ ìœ ì§€)
BEGIN;

-- ê±°ë˜ ê´€ë ¨ ë°ì´í„° ì‚­ì œ
DELETE FROM cashbook_transactions;
DELETE FROM inventory_logs;
DELETE FROM shipments;
DELETE FROM order_items;
DELETE FROM orders;

-- ìƒí’ˆ ì¬ê³  ë¦¬ì…‹
UPDATE products SET on_hand = 0;

-- ì´ë²¤íŠ¸ ë¡œê·¸ëŠ” ì„ íƒì  ì‚­ì œ
DELETE FROM event_logs WHERE created_at < NOW() - INTERVAL '30 days';

COMMIT;
```

#### 1.3 í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±

```sql
-- scripts/generate-test-data.sql ì‹¤í–‰
-- ë˜ëŠ” Node.js ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©
node scripts/generate-test-data.js
```

### 2. ì‚¬ìš©ì ê´€ë¦¬

#### 2.1 ìƒˆ ì‚¬ìš©ì ì¶”ê°€

```sql
-- 1. Supabase Dashboardì—ì„œ auth.users ìƒì„±
-- Authentication > Users > Invite user

-- 2. user_profilesì— í”„ë¡œí•„ ì¶”ê°€
INSERT INTO user_profiles (id, email, name, role, active)
VALUES (
  'auth.usersì˜ UUID',
  'user@example.com',
  'ì‚¬ìš©ìëª…',
  'ORDER_MANAGER', -- ADMIN, ORDER_MANAGER, SHIP_MANAGER
  true
);
```

#### 2.2 ì‚¬ìš©ì ê¶Œí•œ ë³€ê²½

```sql
-- ê¶Œí•œ ë³€ê²½
UPDATE user_profiles 
SET role = 'ADMIN' 
WHERE email = 'user@example.com';

-- ì‚¬ìš©ì ë¹„í™œì„±í™”
UPDATE user_profiles 
SET active = false 
WHERE email = 'user@example.com';
```

#### 2.3 ì‚¬ìš©ì ì‚­ì œ

```sql
-- íŠ¹ì • ì‚¬ìš©ìì˜ ëª¨ë“  ë°ì´í„° ì‚­ì œ
DO $$
DECLARE
  target_user_id UUID := 'user-uuid-here';
BEGIN
  -- ê´€ë ¨ ë°ì´í„° ë¨¼ì € ì‚­ì œ
  DELETE FROM cashbook_transactions WHERE created_by = target_user_id;
  DELETE FROM shipments WHERE created_by = target_user_id;
  DELETE FROM order_items WHERE order_id IN (
    SELECT id FROM orders WHERE created_by = target_user_id
  );
  DELETE FROM orders WHERE created_by = target_user_id;
  DELETE FROM inventory_logs WHERE created_by = target_user_id;
  DELETE FROM products WHERE created_by = target_user_id;
  
  -- ë§ˆì§€ë§‰ìœ¼ë¡œ í”„ë¡œí•„ ì‚­ì œ
  DELETE FROM user_profiles WHERE id = target_user_id;
  
  -- auth.usersëŠ” Dashboardì—ì„œ ì‚­ì œ
END $$;
```

### 3. ë°±ì—… ë° ë³µêµ¬

#### 3.1 ìë™ ë°±ì—… (Supabase)

SupabaseëŠ” ë‹¤ìŒì„ ìë™ìœ¼ë¡œ ì œê³µ:
- Point-in-time Recovery (Pro í”Œëœ)
- ì¼ì¼ ë°±ì—… (Free í”Œëœ: 7ì¼, Pro: 30ì¼)

#### 3.2 ìˆ˜ë™ ë°±ì—…

```bash
# pg_dumpë¥¼ ì‚¬ìš©í•œ ë°±ì—…
pg_dump -h db.your-project.supabase.co \
  -U postgres \
  -d postgres \
  -f backup_$(date +%Y%m%d).sql

# íŠ¹ì • í…Œì´ë¸”ë§Œ ë°±ì—…
pg_dump -h db.your-project.supabase.co \
  -U postgres \
  -d postgres \
  -t orders -t products \
  -f partial_backup.sql
```

#### 3.3 ë°ì´í„° ë‚´ë³´ë‚´ê¸° (Excel)

```bash
# APIë¥¼ í†µí•œ Excel ë‚´ë³´ë‚´ê¸°
curl -H "Authorization: Bearer YOUR_TOKEN" \
  https://your-app.vercel.app/api/export/orders.xlsx \
  -o orders_$(date +%Y%m%d).xlsx
```

### 4. ì •ê¸° ìœ ì§€ë³´ìˆ˜

#### 4.1 ì¼ì¼ ì‘ì—…

```sql
-- ì˜¤ë˜ëœ ì´ë²¤íŠ¸ ë¡œê·¸ ì •ë¦¬ (30ì¼ ì´ìƒ)
DELETE FROM event_logs 
WHERE created_at < NOW() - INTERVAL '30 days';

-- ì„¸ì…˜ ì •ë¦¬
DELETE FROM auth.sessions 
WHERE expires_at < NOW();
```

#### 4.2 ì£¼ê°„ ì‘ì—…

```sql
-- ë°ì´í„°ë² ì´ìŠ¤ í†µê³„ ì—…ë°ì´íŠ¸
ANALYZE;

-- ì¸ë±ìŠ¤ ì¬êµ¬ì„±
REINDEX TABLE orders;
REINDEX TABLE products;

-- ë¯¸ì‚¬ìš© ìƒí’ˆ ë¹„í™œì„±í™”
UPDATE products 
SET active = false 
WHERE on_hand = 0 
  AND id NOT IN (
    SELECT DISTINCT product_id 
    FROM order_items 
    WHERE created_at > NOW() - INTERVAL '90 days'
  );
```

#### 4.3 ì›”ê°„ ì‘ì—…

```sql
-- ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”
VACUUM ANALYZE;

-- ì˜¤ë˜ëœ ì™„ë£Œ ì£¼ë¬¸ ì•„ì¹´ì´ë¸Œ (ì„ íƒì‚¬í•­)
INSERT INTO orders_archive 
SELECT * FROM orders 
WHERE status = 'DONE' 
  AND created_at < NOW() - INTERVAL '6 months';

DELETE FROM orders 
WHERE status = 'DONE' 
  AND created_at < NOW() - INTERVAL '6 months';
```

### 5. ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

#### 5.1 ëŠë¦° ì¿¼ë¦¬ ì°¾ê¸°

```sql
-- ëŠë¦° ì¿¼ë¦¬ í™•ì¸
SELECT 
  query,
  calls,
  mean_exec_time,
  total_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;
```

#### 5.2 í…Œì´ë¸” í¬ê¸° í™•ì¸

```sql
-- í…Œì´ë¸” í¬ê¸° í™•ì¸
SELECT 
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

#### 5.3 ì¸ë±ìŠ¤ ì‚¬ìš©ë¥  í™•ì¸

```sql
-- ì¸ë±ìŠ¤ ì‚¬ìš©ë¥ 
SELECT 
  schemaname,
  tablename,
  indexname,
  idx_scan,
  idx_tup_read,
  idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

### 6. íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

#### 6.1 Foreign Key ì œì•½ ì˜¤ë¥˜

```sql
-- ê³ ì•„ ë°ì´í„° ì°¾ê¸°
SELECT * FROM orders 
WHERE created_by NOT IN (SELECT id FROM user_profiles);

-- ê³ ì•„ ë°ì´í„° ì •ë¦¬
DELETE FROM orders 
WHERE created_by NOT IN (SELECT id FROM user_profiles);
```

#### 6.2 ì¤‘ë³µ ë°ì´í„° ì œê±°

```sql
-- ì¤‘ë³µ ì£¼ë¬¸ ì°¾ê¸°
SELECT customer_phone, COUNT(*) 
FROM orders 
WHERE created_at > NOW() - INTERVAL '1 day'
GROUP BY customer_phone 
HAVING COUNT(*) > 1;

-- ì¤‘ë³µ ì œê±° (ìµœì‹  ê²ƒë§Œ ìœ ì§€)
DELETE FROM orders a
USING orders b
WHERE a.customer_phone = b.customer_phone
  AND a.created_at < b.created_at;
```

#### 6.3 ì¬ê³  ë¶ˆì¼ì¹˜ ìˆ˜ì •

```sql
-- ì¬ê³  ì¬ê³„ì‚°
UPDATE products p
SET on_hand = (
  SELECT COALESCE(SUM(
    CASE 
      WHEN type IN ('INBOUND', 'RETURN') THEN quantity
      WHEN type IN ('SALE', 'ADJUSTMENT') THEN -quantity
    END
  ), 0)
  FROM inventory_logs
  WHERE product_id = p.id
);
```

### 7. ë³´ì•ˆ ê´€ë¦¬

#### 7.1 RLS (Row Level Security) ì ê²€

```sql
-- RLS ì •ì±… í™•ì¸
SELECT 
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual
FROM pg_policies
WHERE schemaname = 'public';
```

#### 7.2 ê¶Œí•œ ê²€í† 

```sql
-- í…Œì´ë¸” ê¶Œí•œ í™•ì¸
SELECT 
  grantee,
  table_name,
  privilege_type
FROM information_schema.role_table_grants
WHERE table_schema = 'public';
```

### 8. ìŠ¤í¬ë¦½íŠ¸ ìë™í™”

#### 8.1 Cron Job ì„¤ì • (Vercel)

```javascript
// api/cron/daily-cleanup.ts
export async function GET(request: Request) {
  // Cron Secret ê²€ì¦
  const authHeader = request.headers.get('authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return new Response('Unauthorized', { status: 401 });
  }

  // ì¼ì¼ ì •ë¦¬ ì‘ì—…
  await cleanupOldLogs();
  await updateStatistics();
  
  return Response.json({ success: true });
}
```

#### 8.2 ë°±ì—… ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# scripts/backup.sh

DATE=$(date +%Y%m%d)
BACKUP_DIR="/backups"

# ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…
pg_dump $DATABASE_URL > $BACKUP_DIR/db_$DATE.sql

# íŒŒì¼ ì••ì¶•
gzip $BACKUP_DIR/db_$DATE.sql

# ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œ (30ì¼ ì´ìƒ)
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete
```

## ğŸ“š ì°¸ê³  ë¬¸ì„œ

- [Supabase Database Functions](https://supabase.com/docs/guides/database/functions)
- [PostgreSQL Maintenance](https://www.postgresql.org/docs/current/maintenance.html)
- [Next.js API Routes](https://nextjs.org/docs/api-routes/introduction)